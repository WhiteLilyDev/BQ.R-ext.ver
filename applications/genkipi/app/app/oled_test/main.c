
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>

#include "ohos_init.h"
#include "cmsis_os2.h"

#include "genki_pin.h"

#include "hi_time.h"
#include "ssd1306_i2c.h"
#include "pca9685.h"
#include "iot_watchdog.h"

#include "iot_pwm.h"
#include "iot_gpio.h"

#define IDX 0
#define ADDRESS_READ 0x78
#define ADDRESS_WRITE 0x79
#define MAX_COLUMN	  128
#define MAX_ROW		  32
#define DELAY_TIME 20000
#define duty_TIME 2000000
#define S05_TIME 500000

char *ctr = "hello mondraker!";
char *open_ctr = "Angle:170";
char *close_ctr = "Angle:30";
unsigned char BMP[] =
        {
                0x00, 0x03, 0x05, 0x09, 0x11, 0xFF, 0x11, 0x89, 0x05, 0xC3, 0x00, 0xE0, 0x00, 0xF0, 0x00, 0xF8,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x28, 0xFF, 0x11, 0xAA, 0x44, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0x01, 0x38, 0x44, 0x82, 0x92,
                0x92, 0x74, 0x01, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x44, 0xC7, 0x01, 0x7D,
                0x7D, 0x7D, 0x7D, 0x01, 0x7D, 0x7D, 0x7D, 0x7D, 0x01, 0x7D, 0x7D, 0x7D, 0x7D, 0x01, 0xFF, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01,
                0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00,
                0x6D, 0x6D, 0x6D, 0x6D, 0x6D, 0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0x00, 0x00,
                0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0x00, 0x00, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0x00, 0x00, 0xDB, 0xDB,
                0xDB, 0xDB, 0xDB, 0x00, 0x00, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0x00, 0x00, 0xD8, 0xD8, 0xD8, 0xD8,
                0xD8, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00,
                0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x80,
                0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00,
                0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x06, 0x06,
                0x06, 0x06, 0x06, 0x00, 0x00, 0x06, 0x06, 0x06, 0xE6, 0x66, 0x20, 0x00, 0x06, 0x06, 0x86, 0x06,
                0x06, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x86, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00,
                0x00, 0x86, 0x86, 0x86, 0x86, 0x86, 0x80, 0x80, 0x86, 0x86, 0x06, 0x86, 0x86, 0xC0, 0xC0, 0x86,
                0x86, 0x86, 0x06, 0x06, 0xD0, 0x30, 0x76, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x06, 0x06, 0x06,
                0x06, 0x06, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06,
                0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x1C, 0x00, 0xFE, 0x00, 0x01,
                0x02, 0x00, 0xC4, 0x18, 0x20, 0x02, 0x9E, 0x63, 0xB2, 0x0E, 0x00, 0xFF, 0x81, 0x81, 0xFF, 0x00,
                0x00, 0x80, 0x40, 0x30, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x23, 0xEA, 0xAA, 0xBF, 0xAA,
                0xEA, 0x03, 0x3F, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x0C, 0x08, 0x00, 0x00, 0x01, 0x01, 0x01,
                0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x81, 0x80, 0x80, 0x81, 0x80,
                0x81, 0x80, 0x80, 0x80, 0x80, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
                0x01, 0x00, 0x01, 0x01, 0x09, 0x0C, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
                0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00,
                0x00, 0x1E, 0x21, 0x40, 0x40, 0x50, 0x21, 0x5E, 0x00, 0x1E, 0x21, 0x40, 0x40, 0x50, 0x21, 0x5E,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xC1, 0xC1, 0xFF,
                0xFF, 0xC1, 0xC1, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0xFC, 0xF3, 0xEF, 0xF3, 0xFC,
                0x80, 0xFF, 0x80, 0xEE, 0xEE, 0xEE, 0xF5, 0xFB, 0xFF, 0x9C, 0xBE, 0xB6, 0xB6, 0x88, 0xFF, 0x00,
        };

static void i2c_init(void) {
    IoTI2cInit(IDX, 400000);
    IoTIoSetFunc(IOT_IO_NAME_10, IOT_IO_FUNC_10_I2C0_SDA);
    IoTIoSetFunc(IOT_IO_NAME_9, IOT_IO_FUNC_9_I2C0_SCL);
}

static void servo_init(void) {
    for (int i = 0; i < 16; i++) {
        pca9685_servo_set_angle(i, 90);
        IoTWatchDogKick();
    }
}

static void all_init(void) {
    IoTWatchDogEnable();
    i2c_init();
    pca9685_servo_init();
    //servo_init();
    OLED_Init();
}


static void oled_show(void) {
    OLED_Fill(0x00);//clear
    hi_udelay(DELAY_TIME);//2000us
    //OLED_ON();
    OLED_Fill(0xff);//full white
    //OLED_SetPos(0,0);
    hi_udelay(DELAY_TIME);//2000us
    OLED_CLS();//clear
    hi_udelay(DELAY_TIME);//2000us
    //lock_i2c();
    //OLED_DrawPoint(1,1,1);
    //OLED_ShowChar(0,0,'A',6*8);
    //OLED_ColorTurn(0);
    OLED_ShowString(0,2,ctr,6*8);
    hi_udelay(duty_TIME);
    //OLED_ShowCN(0,3,1);
    hi_udelay(duty_TIME);//2s
    hi_udelay(duty_TIME);//2s
    OLED_CLS();
    //OLED_DrawBMP(0,0,128,8,BMP);
    //hi_udelay(duty_TIME);//2s
    //OLED_CLS();
    //OLED_ON();
    //hi_udelay(DELAY_TIME);//2000us
    //unlock_i2c();
    //OLED_DrawBMP(0,4,0,128,BMP1[]);
    //hi_udelay(DELAY_TIME);//2000us
}

static void servo_show(unsigned int channel,unsigned int angle) {

    char channel_ctr[4];
    sprintf(channel_ctr,"%d",channel);
    //unsigned int channel = atoi(channel_ctr);

    unsigned int xport[9] = {0,16,32,48,64,80,96,112};
    unsigned int xport2[9] = {48,32,16,0,112,96,80,64};
    unsigned int yport[3] = {0,3};
    if (3<channel&&channel<12){
        OLED_ShowString(xport[channel-4],yport[1],channel_ctr,6*8);
    }else if(0<=channel&&channel<=3){
        OLED_ShowString(xport2[channel],yport[0],channel_ctr,6*8);
    }else if(12<=channel&&channel<=15){
        OLED_ShowString(xport2[channel-8],yport[0],channel_ctr,6*8);
    }
    pca9685_servo_set_angle(channel, angle);
    //hi_udelay(S05_TIME);//0.5s
}

static void multi_test_1(void) {
    OLED_ShowString(6, 0, "[multi_test_1]", 6 * 8);
    OLED_ShowString(0, 2, "ssd1306_i2c 0x78", 6 * 8);
    OLED_ShowString(0, 3, "pca9685_i2c 0x40", 6 * 8);
    hi_udelay(duty_TIME);//2s
    hi_udelay(duty_TIME);//2s
    OLED_CLS();

    while (true) {
        OLED_ShowString(36, 1, close_ctr, 16);
        for (int i = 0; i < 16; i++) {
            servo_show(i, 30);
            IoTWatchDogKick();
        }
        hi_udelay(duty_TIME);//2s
        IoTWatchDogKick();
        OLED_CLS();

        OLED_ShowString(30, 1, open_ctr, 16);
        for (int i = 0; i < 16; i++) {
            servo_show(i, 170);
            IoTWatchDogKick();
        }
        hi_udelay(duty_TIME);//2s
        IoTWatchDogKick();
        OLED_CLS();
    }
}

static void PWM_test(void)
{
    //初始化GPIO7
    IoTGpioInit(IOT_IO_NAME_7);

    //设置GPIO_7引脚复用功能为PWM
    IoTIoSetFunc(IOT_IO_NAME_7, IOT_IO_FUNC_7_PWM0_OUT);

    //设置GPIO_7引脚为输出模式
    IoTGpioSetDir(IOT_IO_NAME_7, IOT_GPIO_DIR_OUT);

    //初始化PWM0端口
    IoTPwmInit(IOT_PWM_NAME_0);

    while (true)
    {
        for (unsigned int i = 0; i < 100; i += 1)
        {

            IoTPwmStart(IOT_PWM_NAME_0, i, 40000);

            usleep(40000);
        }

        for (unsigned int i = 99; i > 0; i -= 1)
        {

            IoTPwmStart(IOT_PWM_NAME_0, i, 40000);

            usleep(40000);
        }

        sleep(0.5);
    }
}

static void test_main(void) {
    all_init();
    printf("hello mondraker!\n");
    OLED_CLS();

    //oled_show();

    while (true) {
        /*
        servo_show(5, 180);
        servo_show(4, 20);
        hi_udelay(duty_TIME);//2s
        OLED_CLS();
        IoTWatchDogKick();
        servo_show(5, 20);
        servo_show(4, 90);
        hi_udelay(duty_TIME);//2s
        OLED_CLS();
        IoTWatchDogKick();

        servo_show(5, 90);//you you +tai
        servo_show(4, 180);//zuo di -tai
        hi_udelay(duty_TIME);//2s
        OLED_CLS();
        IoTWatchDogKick();

        servo_show(5, 20);
        servo_show(4, 90);
        hi_udelay(duty_TIME);//2s
        OLED_CLS();
        IoTWatchDogKick();
*/
        servo_show(5, 45);
        servo_show(4, 180);//shen
        hi_udelay(duty_TIME);//2s
        OLED_CLS();
        IoTWatchDogKick();

        servo_show(5, 20);
        servo_show(4, 100);//tai
        hi_udelay(duty_TIME);//2s
        OLED_CLS();
        IoTWatchDogKick();



    }

    //multi_test_1();

    //PWM_test();

}

static void start(void) {
    osThreadAttr_t attr;

    attr.name = "thread_1";
    attr.attr_bits = 0U;
    attr.cb_mem = NULL;
    attr.cb_size = 0U;
    attr.stack_mem = NULL;
    attr.stack_size = 1024 * 4;
    attr.priority = 25;

    if (osThreadNew((osThreadFunc_t) test_main, NULL, &attr) == NULL) {
        printf("Falied to create test_main!\r\n");
    }
}

APP_FEATURE_INIT(start);

/*LED_TEST
    IoTGpioInit(7);
    IoTGpioSetDir(7, 1);
    while(true) {
        IoTGpioSetOutputVal(7, 1);
        hi_udelay(S05_TIME);
        IoTWatchDogKick();
        IoTGpioSetOutputVal(7, 0);
        hi_udelay(S05_TIME);
    }
*/

/*SERVO_TEST
//pca9685_servo_reset();
OLED_ShowString(30,2,close_ctr,6*8);
hi_udelay(DELAY_TIME);//2000us
pca9685_servo_set_angle(15, 60);
hi_udelay(S05_TIME);//0.5s
pca9685_servo_set_angle(14, 60);
hi_udelay(S05_TIME);//2000us
pca9685_servo_set_angle(8, 60);
hi_udelay(S05_TIME);//2000us
pca9685_servo_set_angle(9, 60);
hi_udelay(duty_TIME);//2s
OLED_CLS();

IoTWatchDogKick();

OLED_ShowString(30,2,open_ctr,6*8);
hi_udelay(DELAY_TIME);//2000us
pca9685_servo_set_angle(15, 75);
hi_udelay(S05_TIME);//2000us
pca9685_servo_set_angle(14, 100);
hi_udelay(S05_TIME);//2000us
pca9685_servo_set_angle(8, 130);
hi_udelay(S05_TIME);//2000us
pca9685_servo_set_angle(9, 160);
hi_udelay(duty_TIME);//2000us
OLED_CLS();

IoTWatchDogKick();
 */